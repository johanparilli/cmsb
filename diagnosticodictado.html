import React, { useState, useRef, useEffect } from 'react';
import { Play, RotateCcw, CheckCircle2, AlertCircle, Music, ChevronRight, Volume2, Info, Users, Send, ClipboardList, RefreshCw, Lock } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from 'firebase/firestore';

// --- CONFIGURACIÓN DE DATOS DEL EXAMEN ---
// Cada pregunta vale 2 puntos para un total de 20.
// Se han eliminado las pistas por tratarse de un examen diagnóstico.
const quizData = {
  title: "Examen Diagnóstico: Dictado musical",
  totalPoints: 20,
  questions: [
    {
      questionNumber: 1,
      category: "INTERVALOS",
      question: "Identifica este intervalo simple ASCENDENTE.",
      type: "interval",
      points: 2,
      params: { notes: [261.63, 392.00] }, // Do - Sol (5ta Justa)
      answerOptions: [
        { text: "Cuarta Justa", isCorrect: false },
        { text: "Quinta Justa", isCorrect: true },
        { text: "Sexta Mayor", isCorrect: false }
      ]
    },
    {
      questionNumber: 2,
      category: "INTERVALOS",
      question: "Identifica este intervalo simple DESCENDENTE.",
      type: "interval",
      points: 2,
      params: { notes: [392.00, 261.63] }, // Sol - Do (5ta Justa Desc)
      answerOptions: [
        { text: "Quinta Justa", isCorrect: true },
        { text: "Cuarta Justa", isCorrect: false },
        { text: "Octava Justa", isCorrect: false }
      ]
    },
    {
      questionNumber: 3,
      category: "INTERVALOS ARMÓNICOS",
      question: "Identifica este intervalo ARMÓNICO (notas simultáneas).",
      type: "chord",
      points: 2,
      params: { notes: [261.63, 329.63] }, // Do - Mi (3ra Mayor)
      answerOptions: [
        { text: "Tercera Menor", isCorrect: false },
        { text: "Tercera Mayor", isCorrect: true },
        { text: "Cuarta Justa", isCorrect: false }
      ]
    },
    {
      questionNumber: 4,
      category: "ESCALAS DIATÓNICAS",
      question: "¿Hacia qué dirección se mueve esta escala diatónica?",
      type: "scale",
      points: 2,
      params: { notes: [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25] },
      answerOptions: [
        { text: "Ascendente", isCorrect: true },
        { text: "Descendente", isCorrect: false }
      ]
    },
    {
      questionNumber: 5,
      category: "ESCALAS DIATÓNICAS",
      question: "Escucha el fragmento. ¿Qué dirección lleva la escala?",
      type: "scale",
      points: 2,
      params: { notes: [523.25, 493.88, 440.00, 392.00, 349.23, 329.63, 293.66, 261.63] },
      answerOptions: [
        { text: "Ascendente", isCorrect: false },
        { text: "Descendente", isCorrect: true }
      ]
    },
    {
      questionNumber: 6,
      category: "CIFRAS INDICADORAS",
      question: "Según la melodía escuchada, ¿cuál es la cifra indicadora?",
      type: "melody_meter",
      points: 2,
      params: { beats: 2, notes: [261.63, 293.66, 329.63, 261.63] }, // 2/4
      answerOptions: [
        { text: "2/4", isCorrect: true },
        { text: "3/4", isCorrect: false },
        { text: "4/4", isCorrect: false }
      ]
    },
    {
      questionNumber: 7,
      category: "CIFRAS INDICADORAS",
      question: "Identifica el compás de esta melodía.",
      type: "melody_meter",
      points: 2,
      params: { beats: 3, notes: [392.00, 349.23, 329.63, 392.00, 349.23, 329.63] }, // 3/4
      answerOptions: [
        { text: "2/4", isCorrect: false },
        { text: "3/4", isCorrect: true },
        { text: "4/4", isCorrect: false }
      ]
    },
    {
      questionNumber: 8,
      category: "CIFRAS INDICADORAS",
      question: "¿Cuál es el compás de este ejercicio melódico?",
      type: "melody_meter",
      points: 2,
      params: { beats: 4, notes: [261.63, 329.63, 392.00, 523.25] }, // 4/4
      answerOptions: [
        { text: "2/4", isCorrect: false },
        { text: "3/4", isCorrect: false },
        { text: "4/4", isCorrect: true }
      ]
    },
    {
      questionNumber: 9,
      category: "INTERVALOS",
      question: "Identifica este intervalo simple ASCENDENTE.",
      type: "interval",
      points: 2,
      params: { notes: [261.63, 349.23] }, // Do - Fa (4ta Justa)
      answerOptions: [
        { text: "Tercera Mayor", isCorrect: false },
        { text: "Cuarta Justa", isCorrect: true },
        { text: "Quinta Justa", isCorrect: false }
      ]
    },
    {
      questionNumber: 10,
      category: "INTERVALOS ARMÓNICOS",
      question: "Identifica este intervalo ARMÓNICO.",
      type: "chord",
      points: 2,
      params: { notes: [261.63, 311.13] }, // Do - Mib (3ra Menor)
      answerOptions: [
        { text: "Tercera Menor", isCorrect: true },
        { text: "Tercera Mayor", isCorrect: false },
        { text: "Segunda Mayor", isCorrect: false }
      ]
    }
  ]
};

// --- INICIALIZACIÓN FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'dictado-musical-johan';
const CLAVE_PROFESOR = "7777";

export default function App() {
  const [user, setUser] = useState(null);
  const [currentStep, setCurrentStep] = useState('start'); 
  const [studentName, setStudentName] = useState('');
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [pointsScored, setPointsScored] = useState(0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [submissions, setSubmissions] = useState([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [passInput, setPassInput] = useState('');
  const [isAuthorized, setIsAuthorized] = useState(false);
  
  const audioCtx = useRef(null);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user || !isAuthorized || currentStep !== 'teacher') return;
    const resultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'results');
    const unsubscribe = onSnapshot(resultsRef, (snapshot) => {
        const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setSubmissions(docs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
      }
    );
    return () => unsubscribe();
  }, [user, isAuthorized, currentStep]);

  const initAudio = async () => {
    if (!audioCtx.current) {
      audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioCtx.current.state === 'suspended') {
      await audioCtx.current.resume();
    }
  };

  const playTone = (freq, duration, startTime, type = 'triangle', volume = 0.12) => {
    const osc = audioCtx.current.createOscillator();
    const gain = audioCtx.current.createGain();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, startTime);
    gain.gain.setValueAtTime(0, startTime);
    gain.gain.linearRampToValueAtTime(volume, startTime + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
    osc.connect(gain);
    gain.connect(audioCtx.current.destination);
    osc.start(startTime);
    osc.stop(startTime + duration);
  };

  const handlePlayAudio = async () => {
    await initAudio();
    if (isPlaying) return;
    setIsPlaying(true);
    
    const q = quizData.questions[currentQuestion];
    const now = audioCtx.current.currentTime;
    let totalDuration = 0;

    switch (q.type) {
      case 'interval':
      case 'scale':
        q.params.notes.forEach((freq, i) => playTone(freq, 0.6, now + (i * 0.7)));
        totalDuration = q.params.notes.length * 0.7;
        break;
      case 'chord':
        q.params.notes.forEach((freq) => playTone(freq, 2, now));
        totalDuration = 2;
        break;
      case 'melody_meter':
        const beatDuration = 0.6;
        for(let bar = 0; bar < 2; bar++) {
          for(let b = 0; b < q.params.beats; b++) {
            const isAccent = b === 0;
            const noteIndex = (bar * q.params.beats + b) % q.params.notes.length;
            playTone(
              q.params.notes[noteIndex], 
              0.5, 
              now + totalDuration, 
              'triangle', 
              isAccent ? 0.25 : 0.08
            );
            totalDuration += beatDuration;
          }
        }
        break;
    }
    setTimeout(() => setIsPlaying(false), totalDuration * 1000);
  };

  const handleAnswerSelect = (index) => {
    if (selectedAnswer !== null) return;
    setSelectedAnswer(index);
    if (quizData.questions[currentQuestion].answerOptions[index].isCorrect) {
      setPointsScored(prev => prev + quizData.questions[currentQuestion].points);
    }
  };

  const nextQuestion = () => {
    if (currentQuestion < quizData.questions.length - 1) {
      setCurrentQuestion(q => q + 1);
      setSelectedAnswer(null);
    } else {
      setCurrentStep('result');
    }
  };

  const submitFinalResults = async () => {
    if (!user || isSubmitting || submitted) return;
    setIsSubmitting(true);
    try {
      const resultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'results');
      await addDoc(resultsRef, {
        name: studentName,
        score: pointsScored,
        total: quizData.totalPoints,
        timestamp: serverTimestamp(),
        userId: user.uid
      });
      setSubmitted(true);
    } catch (e) {
      setIsSubmitting(false);
    }
  };

  const handleTeacherAuth = () => {
    if (passInput === CLAVE_PROFESOR) {
        setIsAuthorized(true);
    } else {
        alert("Clave incorrecta");
        setPassInput('');
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-900 flex items-center justify-center">
      <div className="w-full max-w-xl bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col min-h-[600px] border border-slate-200">
        
        {/* Banner Superior */}
        <div className="bg-indigo-600 p-6 text-white text-center relative">
          <button 
            onClick={() => setCurrentStep('teacher')} 
            className="absolute top-4 right-4 p-2 bg-indigo-500 rounded-full hover:bg-indigo-400 transition-colors"
          >
            <Users className="w-4 h-4" />
          </button>
          <h1 className="text-xl font-black uppercase tracking-tight">{quizData.title}</h1>
        </div>

        <div className="p-8 flex-1 flex flex-col">
          
          {currentStep === 'start' && (
            <div className="text-center my-auto space-y-6">
              <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mx-auto text-indigo-600 border-4 border-white shadow-md">
                <Music className="w-10 h-10" />
              </div>
              <div className="space-y-2">
                <h2 className="text-xl font-bold">Registro de Estudiante</h2>
                <input 
                  type="text" 
                  placeholder="Tu nombre completo"
                  value={studentName}
                  onChange={(e) => setStudentName(e.target.value)}
                  className="w-full p-4 border-2 border-slate-100 rounded-2xl focus:border-indigo-500 outline-none transition-all font-bold text-center"
                />
              </div>
              <button 
                onClick={() => setCurrentStep('quiz')}
                disabled={!studentName.trim()}
                className="w-full bg-indigo-600 disabled:bg-slate-200 text-white py-4 rounded-2xl font-black transition-all uppercase tracking-widest shadow-lg hover:bg-indigo-700"
              >
                Comenzar Examen (Puntaje: {quizData.totalPoints})
              </button>
            </div>
          )}

          {currentStep === 'quiz' && (
            <div className="space-y-6 flex-1">
              <div className="flex items-center gap-4">
                <div className="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                  <div className="bg-indigo-600 h-full transition-all duration-500" style={{ width: `${((currentQuestion + 1) / quizData.questions.length) * 100}%` }}></div>
                </div>
                <span className="text-[10px] font-black text-slate-400">{currentQuestion + 1}/{quizData.questions.length}</span>
              </div>

              <div className="space-y-1">
                <div className="flex justify-between items-center">
                  <span className="text-indigo-600 text-[10px] font-black uppercase tracking-widest">{quizData.questions[currentQuestion].category}</span>
                  <span className="text-slate-400 text-[9px] font-bold uppercase tracking-widest">{quizData.questions[currentQuestion].points} Pts</span>
                </div>
                <h2 className="text-lg font-bold text-slate-800 leading-tight">{quizData.questions[currentQuestion].question}</h2>
              </div>

              <div className="bg-slate-900 rounded-2xl p-8 flex flex-col items-center gap-4 border-4 border-slate-800 shadow-inner">
                <button 
                  onClick={handlePlayAudio}
                  className={`w-16 h-16 rounded-full flex items-center justify-center transition-all ${isPlaying ? 'bg-indigo-500/20 text-indigo-400' : 'bg-indigo-600 text-white hover:scale-105 shadow-xl shadow-indigo-500/30'}`}
                >
                  {isPlaying ? <RefreshCw className="animate-spin" /> : <Play fill="white" className="w-7 h-7 ml-1" />}
                </button>
                <p className="text-[10px] text-indigo-300 font-bold uppercase tracking-widest">
                  {isPlaying ? "Reproduciendo..." : "Reproducir Sonido"}
                </p>
              </div>

              <div className="space-y-3">
                {quizData.questions[currentQuestion].answerOptions.map((opt, i) => (
                  <button
                    key={i}
                    onClick={() => handleAnswerSelect(i)}
                    disabled={selectedAnswer !== null}
                    className={`w-full p-4 rounded-xl border-2 text-left transition-all text-sm font-bold ${
                      selectedAnswer === null ? 'border-slate-100 bg-slate-50 hover:border-indigo-200' :
                      opt.isCorrect ? 'border-emerald-500 bg-emerald-50 text-emerald-800' :
                      selectedAnswer === i ? 'border-rose-500 bg-rose-50 text-rose-800' : 'border-slate-50 opacity-40'
                    }`}
                  >
                    <div className="flex justify-between items-center">
                      <span>{opt.text}</span>
                      {selectedAnswer !== null && opt.isCorrect && <CheckCircle2 className="w-4 h-4" />}
                    </div>
                  </button>
                ))}
              </div>

              {selectedAnswer !== null && (
                <div className="flex justify-end pt-4">
                  <button onClick={nextQuestion} className="bg-slate-900 text-white py-3 px-8 rounded-xl font-bold flex items-center justify-center gap-2 text-xs uppercase tracking-widest hover:bg-indigo-600 transition-all">
                    {currentQuestion === quizData.questions.length - 1 ? 'Calificar' : 'Siguiente'}
                    <ChevronRight className="w-4 h-4" />
                  </button>
                </div>
              )}
            </div>
          )}

          {currentStep === 'result' && (
            <div className="text-center my-auto space-y-6 animate-in">
              <div className="w-24 h-24 rounded-full border-8 border-indigo-600 flex items-center justify-center mx-auto bg-indigo-50 shadow-inner">
                <div className="flex flex-col items-center">
                  <span className="text-3xl font-black text-indigo-600">{pointsScored}</span>
                  <span className="text-[10px] font-bold text-slate-400">DE 20</span>
                </div>
              </div>
              <h2 className="text-2xl font-black">Examen Finalizado</h2>
              
              {!submitted ? (
                <button 
                  onClick={submitFinalResults}
                  disabled={isSubmitting}
                  className="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-4 rounded-2xl font-black flex items-center justify-center gap-2 transition-all shadow-lg uppercase tracking-widest"
                >
                  {isSubmitting ? <RefreshCw className="animate-spin" /> : <><Send className="w-5 h-5" /> Enviar Calificación</>}
                </button>
              ) : (
                <div className="bg-emerald-100 text-emerald-700 p-5 rounded-2xl font-black flex flex-col items-center justify-center gap-2 border-2 border-emerald-200">
                  <CheckCircle2 className="w-8 h-8" /> ¡Calificación Registrada!
                </div>
              )}
              
              <button onClick={() => window.location.reload()} className="text-slate-400 text-[10px] font-bold uppercase hover:text-indigo-600">Reiniciar</button>
            </div>
          )}

          {currentStep === 'teacher' && (
            <div className="flex-1 flex flex-col h-full animate-in">
                {!isAuthorized ? (
                    <div className="my-auto text-center space-y-6">
                        <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto text-slate-400 border-2 border-slate-200">
                            <Lock className="w-8 h-8" />
                        </div>
                        <h2 className="font-bold">Acceso de Administrador</h2>
                        <input 
                            type="password" 
                            placeholder="Clave maestra" 
                            value={passInput}
                            onChange={(e) => setPassInput(e.target.value)}
                            className="w-full p-4 border-2 border-slate-100 rounded-2xl focus:border-indigo-500 outline-none text-center font-bold"
                        />
                        <div className="flex gap-2">
                            <button onClick={() => setCurrentStep('start')} className="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-xs uppercase text-slate-500">Volver</button>
                            <button onClick={handleTeacherAuth} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold text-xs uppercase tracking-widest">Entrar</button>
                        </div>
                    </div>
                ) : (
                    <>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold flex items-center gap-2 text-indigo-600"><ClipboardList className="w-5 h-5" /> Registro</h2>
                            <button onClick={() => { setIsAuthorized(false); setCurrentStep('start'); }} className="text-[10px] font-bold text-slate-400 uppercase border px-3 py-1 rounded-lg">Cerrar</button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto pr-2 space-y-2 scrollbar-hide">
                            {submissions.length === 0 ? (
                                <div className="text-center py-20 text-slate-400 italic text-sm">Aún no hay registros.</div>
                            ) : (
                                submissions.map((res) => (
                                    <div key={res.id} className="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center hover:bg-white transition-all">
                                        <div>
                                            <p className="font-bold text-slate-800 text-sm truncate max-w-[200px]">{res.name}</p>
                                            <p className="text-[9px] text-slate-400 font-bold uppercase">
                                            {res.timestamp?.toDate().toLocaleString() || 'Sincronizando...'}
                                            </p>
                                        </div>
                                        <div className="bg-indigo-600 text-white w-12 h-10 flex flex-col items-center justify-center rounded-xl font-black leading-none">
                                            <span className="text-lg">{res.score}</span>
                                            <span className="text-[7px]">/ 20</span>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </>
                )}
            </div>
          )}

        </div>

        <div className="bg-slate-50 p-4 text-center border-t text-[9px] text-slate-400 font-black tracking-widest uppercase italic">
          Cátedra de Lenguaje Musical Profesor Johan Parilli
        </div>
      </div>
    </div>
  );
}
